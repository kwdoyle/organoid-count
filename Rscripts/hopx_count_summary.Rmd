---
title: "HopX Organoid Colocalization"
output: html_document
date: "`r Sys.Date()`"
---

```{r htmlsetup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r functions, include=FALSE}
library(tidyverse)
library(readxl)
library(MASS)
library(knitr)
library(kableExtra)
library(ggbeeswarm)
library(gridExtra)
library(ggpubr)
source(here::here("./Rscripts/colocalization_functions.R"))

```


```{r datasetup, include=FALSE, warning=FALSE, message=FALSE}

sex_analyze <- c("M", "F")
correct_p <- TRUE
# agg_full_img <- FALSE 
plot_all_agg <- TRUE 
shownewplot <- TRUE 
showsections <- TRUE 
correctp <- TRUE 
toprocess <- "hopx"

# key for calculations
# lcn2_calc_key <- list(tdt_express_lcn2 = "lcn2 tdt / tdt",
#                        lcn2_express_tdt = "lcn2 tdt / lcn2",
#                        spc_express_lcn2 = "lcn2 spc / spc",
#                        lcn2_express_spc = "lcn2 spc / lcn2",
#                        lcn2_spc_express_tdt = "lcn2 spc / tdt",
#                        tdt_express_lcn2_spc = "lcn2 tdt spc / tdt",
#                        tdt_express_spc_minus_lcn2 = "tdt spc minus lcn2 / tdt",
#                        tdt_express_spc = "tdt spc / tdt",
#                        spc_express_tdt = "tdt spc / spc",
#                        dapi_express_tdt_spc = "tdt spc / dapi",
#                        tdt_spc_express_lcn2 = "lcn2 tdt spc / tdt spc")

hopx_calc_key <- list(dapi_express_hopx = "hopx dapi / dapi",
                      hopx_express_dapi = "hopx dapi / hopx",
                      hopx_express_spc = "hopx dapi spc / hopx",
                      tdt_express_spc = "tdt spc / tdt",
                      spc_express_tdt = "tdt spc / spc",
                      tdt_express_hopx = "hopx dapi tdt / tdt",
                      tdt_express_hopx_spc = "hopx dapi tdt spc / tdt",
                      spc_express_hopx_tdt = "hopx dapi tdt spc / spc",
                      spc_express_hopx = "hopx dapi spc / spc",
                      tdt_express_hopx_minus_spc = "hopx dapi tdt minus spc / tdt",
                      dapi_express_hopx_minus_spc = "hopx dapi minus spc / dapi",
                      hopx_express_dapi_minus_spc = "hopx dapi minus spc / hopx")
                      


formlst <- list(hopx=hopx_calc_key)

# Note: to run this summary script, will need to provide this table of sample IDs
# columns should include: 'Day' (day sample was harvested), 'ID' (the numeric sample ID), 'GT' (sample genotype),
# 'Sex' (sex of sample), and 'BleoDose' (amount of bleomycin sample received) or 'Virus' (GT of AAV sample received)
mouseinfo <- read_xlsx(paste0(here::here(), "/organoid_info.xlsx"))
# mouseinfo <- read_xlsx("C:/Users/kd2630/OneDrive - cumc.columbia.edu/Colocalization/mouse_id_info.xlsx")
outputs_raw <- list.files(paste0(here::here(), "/out/"), pattern="*.xlsx", recursive = T, full.names = T)
# fix Hz label
# mouseinfo$GT <- str_replace_all(mouseinfo$GT, "HZ", "Hz")

# separate out the additional sections to look at separately
outputs_all <- outputs_raw[!grepl("out_sep", outputs_raw)] 
outputs_all <- outputs_raw[!grepl("testing", outputs_raw)] 
outputs_all <- outputs_all[grep(toprocess, outputs_all)]

# separate out the additional sections to look at separately
outputs <- outputs_all[!grepl("addtl_sections", outputs_all)]
# outputs_sec2 <- outputs_all[grepl("addtl_sections2", outputs_all)]
# outputs_sec3 <- outputs_all[grepl("addtl_sections3", outputs_all)]


outs_sec1 <- createOuts(datfls=outputs, formnms=formlst, dapithresh=0)
sumOuts_sec1 <- outs_sec1$split_section_output
# fullOuts_sec1 <- outs_sec1$full_slide_output  # this is the same as the 'split' output, since I'm processing the full image anyway

# outs_sec2 <- createOuts(datfls=outputs_sec2, formnms=formlst, dapithresh=1000)
# sumOuts_sec2 <- outs_sec2$split_section_output
# fullOuts_sec2 <- outs_sec2$full_slide_output
# 
# outs_sec3 <- createOuts(datfls=outputs_sec3, formnms=formlst, dapithresh=1000)
# sumOuts_sec3 <- outs_sec3$split_section_output
# fullOuts_sec3 <- outs_sec3$full_slide_output

# List of sumOuts and slices
# if (agg_full_img) {
#   sumOuts_list <- list(fullOuts_sec1, fullOuts_sec2, fullOuts_sec3)
# } else {
#   sumOuts_list <- list(sumOuts_sec1, sumOuts_sec2, sumOuts_sec3)
# }
slices <- 1  #1:3

sumOuts_list <- list(sumOuts_sec1)

# Process each section and bind the results
hopx_df1 <- map2_dfr(sumOuts_list, slices, ~ processSection(.x, .y, "hopx", mouseinfo, sex_analyze))

# set order
basenms_select <- c("section", "id", "type", "slice", "Day", "GT", "Sex")  #, "BleoDose")
if (nrow(hopx_df1) > 0) {
  hopx_df1 <- hopx_df1 %>%
    dplyr::select(any_of(basenms_select),everything())
    # dplyr::select(any_of(basenms_select), spc_express_tdt, tdt_express_spc, dapi_express_hopx, hopx_express_dapi, #dapi_express_tdt_spc,
    #               tdt_express_hopx, tdt_express_hopx_spc, spc_express_hopx_tdt, spc_express_hopx, 
    #               tdt_express_hopx_minus_spc, dapi_express_hopx_minus_spc, hopx_express_dapi_minus_spc)
}


hopx_start_idx <- min(grep('express', names(hopx_df1)))

# HopX
hopx_plt_out <- processDF(df=hopx_df1, calc_key=hopx_calc_key, start_idx=hopx_start_idx, plotallagg=plot_all_agg,
                          show_p_correct=correctp, labelsize=20, ptsize=1.5, rm_outliers=F, makemainfig=T)
hopx_df <- hopx_plt_out$df

# Note: plot_out_X is a nested list of N long, where N is the number of parameters (hopx tdt spc / tdt, etc.) analyzed.
# For each of these, there is another list of 2 long, containing the plots and the wilcox test summaries.
# The plot length is 3
plot_vars_hopx <- hopx_plt_out$plot_vars
plot_out_hopx <- hopx_plt_out$plot_lst
plot_lst_hopx <- lapply(plot_out_hopx, `[[`, 1)  # taking the 'plots' element of the list
plot_tst_hopx <- lapply(plot_out_hopx, `[[`, 2)  # taking the 'tests' element of the list
dayGTtests_hopx.l <- lapply(plot_tst_hopx, `[[`, 1)
# full test df
dayGTtests_hopx <- bind_rows(dayGTtests_hopx.l)
# check data in test
dayGTtests_hopx.plots.l <- lapply(plot_tst_hopx, `[[`, 2)
names(dayGTtests_hopx.plots.l) <- sapply(plot_tst_hopx, function(x) unique(x$wilcoxdf$param))


# replace the param value with the calc_key value
dayGTtests_hopx <- dayGTtests_hopx %>%
  dplyr::rename(param2=param) %>%
  left_join(data.frame(nm=names(hopx_calc_key), param=unlist(hopx_calc_key, use.names=F)), by=c("param2"="nm"))
dayGTtests_hopx <- dayGTtests_hopx[,-which(names(dayGTtests_hopx) == "param2")]


# turn to scientific notation
dayGTtests_hopx$p_signif <- ifelse(dayGTtests_hopx$p_adj < 0.05, 1, 0)

dayGTtests_hopx$p_value <- format(dayGTtests_hopx$p_value, scientific=T, digits=3)
dayGTtests_hopx$p_adj <- format(dayGTtests_hopx$p_adj, scientific=T, digits=3)

all_dfs <- list(hopx=hopx_df)

funckeys <- list(hopx=hopx_calc_key)

# if tests don't exist, set to NULL
if (nrow(dayGTtests_hopx) != 0) {
  hopxtst <- dayGTtests_hopx
} else {
  hopxtst <- NULL
}

```

#### Plotting percentages calculated per each 9x4 section with DAPI count > 0; SPC > 10; tdt > 10

# Hopx
## Analysis of `r ifelse(sex_analyze == "M", yes="Male", no=ifelse(sex_analyze == "F", yes="Female", no="NA"))` mice treated with `r unique(hopx_df$BleoDose)` U/kg bleomycin

```{r info_hopx, echo=FALSE, message=FALSE, eval=showsections}
if (!is.null(hopx_df) & 'section' %in% names(hopx_df)) {
  print(paste("IDs:", paste(unique(hopx_df$id), collapse=", ")))
  print(paste("Sex:", paste(unique(hopx_df$Sex), collapse=", ")))
  sectiondf1 <- hopx_df %>% 
    group_by(id, slice) %>% 
    summarise(sections_used = paste(unique(section), collapse=", "))
  kable(sectiondf1)
}
```


#### Wilcoxon-Mann-Whitney test performed on 'slices combined' compare GT across mice per day
#### and GT per day between males and females, separately

```{r plot_facet_hopx, echo=FALSE, fig.height=20, fig.width=19, warning=FALSE, message=FALSE, results='hide', eval=shownewplot}
if (!is.null(hopx_df)) {
  # good dims: 6x17
  # new good dims: height=27, width=17
  # note: dimensions of plots are designed to view after knitting
  
  if (class(plot_lst_hopx) != "try-error") {
    for (pltgrp in plot_lst_hopx) {
      heights <- c(1, 2)
      newgrp <- pltgrp[-3]
      print(newgrp)
      cat('\n\n\n\n')
    }
  } else {
    print(paste("No data for sex", sex_analyze))
  }
}
```


```{r plot_main_hopx, fig.height=10, fig.width=19, echo=FALSE, warning=FALSE, message=FALSE, results='hide', eval=shownewplot}
if (!is.null(hopx_df)) {
  # good dims: 6x17
  # new good dims: height=27, width=17
  # note: dimensions of plots are designed to view after knitting
  
  if (class(plot_lst_hopx) != "try-error") {
    for (pltgrp in plot_lst_hopx) {
      heights <- c(1, 2)
      newgrp <- pltgrp[3]
      print(newgrp)
      cat('\n\n\n\n')
    }
  } else {
    print(paste("No data for sex", sex_analyze))
  }
}

```

### Wilcoxon-Mann-Whitney test
##### Table shows test of GT per day for 'M+F slices combined'
##### Bonferroni corrected across all `r length(unique(hopxtst$Day))` day observations at alpha = 0.05
##### separately for each `r length(unique(hopxtst$param))` parameters tested for hopx for GT per day
##### alpha~new~ = 0.05 / `r length(unique(hopxtst$Day))` = `r 0.05 / length(unique(hopxtst$Day))`


```{r hopxtest, echo=FALSE}
  if (!is.null(hopxtst)) {
    kable(hopxtst) %>% 
      kable_styling %>% 
      row_spec(which(hopxtst$p_signif == 1), bold=T, hline_after=T, background="lightgrey") %>% 
      remove_column(which(names(hopxtst) == "p_signif"))
  } else if (exists("hopx_aov")) {  # not needed if not running anova
    kable(hopx_aov) %>% 
      kable_styling %>% 
      row_spec(which(hopx_aov$p < 0.05), bold=T, hline_after=T, background="lightgrey")
    kable(hopx_aov) %>% 
      kable_styling %>% 
      row_spec(which(hopx_aov$p < 0.05), bold=T, hline_after=T, background="lightgrey")
  } else {
    print("No comparison results for hopx")
  }

```
